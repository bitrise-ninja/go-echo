format_version: 5
default_step_lib_source: https://github.com/bitrise-io/bitrise-steplib.git

app:
  envs:
  - STEP_VERSION: 0.9.0

workflows:
  test:
    before_run:
    - audit-this-step
    steps:
    - go-list:
    - golint:
    - errcheck:
    - go-test:
    - path::./:
        title: Step Test
        inputs:
        - message: Hello World!

  audit-this-step:
    steps:
    - script:
        title: Audit step.yml
        inputs:
        - content: |-
            #!/bin/bash
            set -ex
            stepman audit --step-yml ./step.yml

  release:
    before_run:
    - test
    steps:
    - script:
        title: Create CHANGELOG and git release
        inputs:
        - content: |-
            #!/bin/bash
            set -ex
            go get github.com/bitrise-tools/releaseman
            export CI=true
            releaseman create \
              --version $STEP_VERSION

  share:
    envs:
      - MY_STEPLIB_REPO_FORK_GIT_URL: $MY_STEPLIB_REPO_FORK_GIT_URL
      - STEP_ID_IN_STEPLIB: go-echo
      - STEP_GIT_VERION_TAG_TO_SHARE: $STEP_VERSION
      - STEP_GIT_CLONE_URL: https://github.com/godrei/steps-go-echo.git
    before_run:
    - test
    steps:
    - script:
        inputs:
        - content: |-
            #!/bin/bash
            set -ex
            bitrise share start -c ${MY_STEPLIB_REPO_FORK_GIT_URL}
            bitrise share create \
                --stepid ${STEP_ID_IN_STEPLIB} \
                --tag ${STEP_GIT_VERION_TAG_TO_SHARE} \
                --git ${STEP_GIT_CLONE_URL}
            bitrise share finish

  dep-update:
    steps:
    - script:
        title: Dependency update
        inputs:
        - content: |-
            #!/bin/bash
            set -ex
            go get -u -v github.com/golang/dep/cmd/dep
            dep ensure -v
            dep ensure -v -update
